# -*- coding: utf-8 -*-

from PIL import Image
from tqdm import tqdm
import binascii
import glob
import os

import numpy as np

from keras.preprocessing.image import img_to_array

dataCnt = 0
dataNum = 9000
width = 100
height = 100
channels = 3
dataset = np.zeros(shape=(dataNum,height,width, channels), dtype=np.float32)

def main():
  global dataCnt
  malware_path = './bytes'
  malware_categories = os.listdir(malware_path + '/')

  dataCnt = 0
  cnt = 0

  for malware_family in tqdm(malware_categories):
    malware_files = glob.glob(malware_path + '/' + malware_family + '/*.txt')
    for malware_file in tqdm(malware_files) :
      print("file name: " , malware_file)
      if not malware_file:
        continue
      try:
        f = open(malware_file, 'r')
        code = f.readlines()
        one_line = ''
        for line in code:
          line = line.replace("+", "")
          line = line.replace("\n", "")
          if len(line) != 2:
            print(str(len(line)) + "### " + line)
          one_line = one_line + line
        BinarySrcCode = binascii.unhexlify(one_line)
        code_len = len(BinarySrcCode)
        padLen = width * height * 3 - code_len
        if (code_len == 0):
          continue
        if padLen < 0:
          print("file is over")
          cnt += 1
          continue
        zeroPad = bytes(padLen)
        
        image = bytearray(BinarySrcCode) + bytes(zeroPad)
        img = Image.frombytes("RGB", (height, width), bytes(list(image)))

        ## 여기서 에러 발생
        img.save("./malware_images/" + malware_family + "/" + malware_file[17:-4] + ".PNG", "PNG")
        print(8)
        dataCnt += 1

      except Exception as ex:
        print(malware_file)
        print(ex)
        return
  
  print("num of exceeded sol : ", cnt)
  print("num of total vul : ", dataCnt)

  return

main()
